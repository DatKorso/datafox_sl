#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ WB.
–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.analytic_report_helpers import get_wb_image_url, download_wb_image

def test_url_generation():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é URL –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤ WB."""
    
    test_cases = [
        ("12345", "basket-01"),     # –ú–∞–ª—ã–π –∞—Ä—Ç–∏–∫—É–ª
        ("1234567", "basket-01"),   # –°—Ä–µ–¥–Ω–∏–π –∞—Ä—Ç–∏–∫—É–ª  
        ("98765432", "basket-01"),  # –ë–æ–ª—å—à–æ–π –∞—Ä—Ç–∏–∫—É–ª –¥–æ 143*100000
        ("15000000", "basket-02"),  # –ê—Ä—Ç–∏–∫—É–ª –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        ("50000000", "basket-04"),  # –ê—Ä—Ç–∏–∫—É–ª –¥–ª—è —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        ("141944890", "basket-10"), # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–∞
        ("163509411", "basket-11"), # –ï—â–µ –ø—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–∞
        ("297267075", "basket-18"), # –¢—Ä–µ—Ç–∏–π –ø—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–∞
        ("999999999", "basket-25")  # –û—á–µ–Ω—å –±–æ–ª—å—à–æ–π –∞—Ä—Ç–∏–∫—É–ª
    ]
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:")
    print("-" * 60)
    
    for wb_sku, expected_server in test_cases:
        url = get_wb_image_url(wb_sku)
        print(f"WB SKU: {wb_sku:>10} ‚Üí {url}")
        
        # –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
        if wb_sku == "141944890":
            expected_url = "https://basket-10.wbbasket.ru/vol1419/part141944/141944890/images/tm/1.webp"
            print(f"{'':>25} –û–∂–∏–¥–∞–ª—Å—è: {expected_url}")
            if url == expected_url:
                print(f"{'‚úÖ URL –¢–û–ß–ù–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç':>25}")
            else:
                print(f"{'‚ùå URL –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç':>25}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ URL —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–π —Å–µ—Ä–≤–µ—Ä
        elif expected_server in url:
            print(f"{'‚úÖ –°–µ—Ä–≤–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π':>25} ({expected_server})")
        else:
            print(f"{'‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞':>25} (–æ–∂–∏–¥–∞–ª—Å—è {expected_server})")
        print()

def test_image_download(wb_sku: str = "141944890"):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞."""
    
    print(f"üñºÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è WB SKU: {wb_sku}")
    print("-" * 60)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL
    url = get_wb_image_url(wb_sku)
    print(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL: {url}")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
    image_data = download_wb_image(wb_sku, timeout=30)
    
    if image_data:
        print(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ")
        print(f"   –†–∞–∑–º–µ—Ä: {len(image_data.getvalue())} –±–∞–π—Ç")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
        image_data.seek(0)
        first_bytes = image_data.read(12)
        
        if first_bytes.startswith(b'RIFF') and b'WEBP' in first_bytes:
            print(f"   –§–æ—Ä–º–∞—Ç: WebP ‚úÖ")
        elif first_bytes.startswith(b'\xFF\xD8\xFF'):
            print(f"   –§–æ—Ä–º–∞—Ç: JPEG")
        elif first_bytes.startswith(b'\x89PNG'):
            print(f"   –§–æ—Ä–º–∞—Ç: PNG")
        else:
            print(f"   –§–æ—Ä–º–∞—Ç: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ({first_bytes[:4].hex()})")
    else:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")

def test_multiple_downloads():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –∏–∑ –ª–æ–≥–∞."""
    
    test_skus = ["141944890", "163509411", "297267075"]
    
    print("üñºÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –∏–∑ –ª–æ–≥–∞:")
    print("-" * 60)
    
    for sku in test_skus:
        print(f"\n–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WB SKU: {sku}")
        url = get_wb_image_url(sku)
        print(f"URL: {url}")
        
        image_data = download_wb_image(sku, timeout=30)
        if image_data:
            print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(image_data.getvalue())} –±–∞–π—Ç")
        else:
            print(f"‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    
    print("üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ WB")
    print("=" * 70)
    print()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é URL
    test_url_generation()
    
    print()
    print("=" * 70)
    print()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    test_wb_sku = sys.argv[1] if len(sys.argv) > 1 else "141944890"
    test_image_download(test_wb_sku)
    
    print()
    print("=" * 70)
    print()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
    test_multiple_downloads()

if __name__ == "__main__":
    main() 