# Схема Базы Данных (db_schema.md)

## Введение

Этот документ описывает структуру базы данных, созданную на основе `mp_reports_schema.md`. Он включает таблицы, их поля, типы данных, предполагаемые первичные (PK) и внешние ключи (FK), а также возможные связи между таблицами.

**Важно:** Первичные и внешние ключи не были явно определены в `mp_reports_schema.md`. Представленные здесь PK и FK являются предположениями, основанными на общих практиках проектирования баз данных. Пожалуйста, проверьте и скорректируйте их в соответствии с вашей бизнес-логикой.

## Инструкции по Заполнению (для дальнейших пользовательских модификаций)

1.  **Таблицы:** Для каждой таблицы в базе данных создайте отдельный раздел.
2.  **Поля (Колонки):** В каждой таблице перечислите все поля.
    *   **Название Поля:** Имя колонки в таблице.
    *   **Тип Данных:** SQL тип данных (например, `VARCHAR`, `INTEGER`, `DATE`, `DOUBLE`, `BOOLEAN`).
    *   **PK (Первичный Ключ):** "Да" если поле является частью первичного ключа.
    *   **FK (Внешний Ключ):** Если поле является внешним ключом, укажите таблицу и поле, на которое оно ссылается, в формате `ССЫЛАЕТСЯ_НА_ТАБЛИЦУ(поле_в_той_таблице)`.
    *   **NULL (Допустимы ли NULL значения):** "Да" или "Нет" (предполагается "Да", если не указано иное или не является PK).
    *   **Описание:** Краткое описание поля и его назначения.
3.  **Связи между Таблицами:** После описания всех таблиц, опишите ключевые связи между ними.

---

## Описание Таблиц и Связей (на основе mp_reports_schema.md)

### `oz_orders` (Заказы Ozon)

*   **Описание:** Содержит информацию о заказах, сделанных на Ozon.
*   **Колонки:**
    | Название Поля        | Тип Данных | PK  | FK (Ссылается на)          | NULL | Описание                                     |
    |----------------------|------------|-----|----------------------------|------|----------------------------------------------|
    | `oz_order_number`    | `VARCHAR`  | Да  |                            | Нет  | Номер заказа Ozon                            |
    | `oz_shipment_number` | `VARCHAR`  |     |                            | Да   | Номер отправления                            |
    | `oz_accepted_date`   | `DATE`     |     |                            | Да   | Дата принятия заказа в обработку             |
    | `order_status`       | `VARCHAR`  |     |                            | Да   | Статус заказа                                |
    | `oz_sku`             | `INTEGER`  |     | `oz_products(oz_sku)`      | Да   | SKU товара на Ozon (из заказа)               |
    | `oz_vendor_code`     | `VARCHAR`  |     | `oz_products(oz_vendor_code)` | Да   | Артикул товара от продавца (из заказа)        |

### `oz_products` (Товары Ozon)

*   **Описание:** Содержит информацию о товарах на платформе Ozon.
*   **Колонки:**
    | Название Поля        | Тип Данных | PK  | FK (Ссылается на) | NULL | Описание                                     |
    |----------------------|------------|-----|-------------------|------|----------------------------------------------|
    | `oz_product_id`      | `INTEGER`  | Да  |                   | Нет  | Ozon Product ID                              |
    | `oz_vendor_code`     | `VARCHAR`  |     |                   | Да   | Артикул товара от продавца                   |
    | `oz_sku`             | `INTEGER`  |     |                   | Да   | SKU товара на Ozon                           |
    | `oz_brand`           | `VARCHAR`  |     |                   | Да   | Бренд товара                                 |
    | `oz_product_status`  | `VARCHAR`  |     |                   | Да   | Статус товара                                |
    | `oz_product_visible` | `VARCHAR`  |     |                   | Да   | Видимость на Ozon                            |
    | `oz_hiding_reasons`  | `VARCHAR`  |     |                   | Да   | Причины скрытия                              |
    | `oz_fbo_stock`       | `INTEGER`  |     |                   | Да   | Доступно к продаже по схеме FBO, шт.         |
    | `oz_actual_price`    | `DOUBLE`   |     |                   | Да   | Текущая цена с учетом скидки, ₽             |

### `oz_barcodes` (Штрихкоды Ozon)

*   **Описание:** Содержит информацию о штрихкодах товаров Ozon. PK здесь не ясен, возможно составной.
*   **Колонки:**
    | Название Поля      | Тип Данных | PK  | FK (Ссылается на)              | NULL | Описание                                     |
    |--------------------|------------|-----|--------------------------------|------|----------------------------------------------|
    | `oz_vendor_code`   | `VARCHAR`  | ?   | `oz_products(oz_vendor_code)`  | Да   | Артикул товара                               |
    | `oz_product_id`    | `INTEGER`  | ?   | `oz_products(oz_product_id)`   | Да   | Ozon ID товара                               |
    | `oz_barcode`       | `VARCHAR`  | ?   |                                | Да   | Штрихкод                                     |

### `wb_products` (Товары Wildberries)

*   **Описание:** Содержит информацию о товарах на платформе Wildberries.
*   **Колонки:**
    | Название Поля   | Тип Данных | PK  | FK (Ссылается на) | NULL | Описание                                     |
    |-----------------|------------|-----|-------------------|------|----------------------------------------------|
    | `wb_sku`        | `INTEGER`  | Да  |                   | Нет  | Артикул WB                                   |
    | `wb_category`   | `VARCHAR`  |     |                   | Да   | Категория продавца                           |
    | `wb_brand`      | `VARCHAR`  |     |                   | Да   | Бренд                                        |
    | `wb_barcodes`   | `VARCHAR`  |     |                   | Да   | Баркоды (может быть список через ";")       |
    | `wb_size`       | `INTEGER`  |     |                   | Да   | Размер                                       |

### `wb_prices` (Цены Wildberries)

*   **Описание:** Содержит информацию о ценах и скидках на товары Wildberries.
*   **Колонки:**
    | Название Поля   | Тип Данных | PK  | FK (Ссылается на)       | NULL | Описание                                     |
    |-----------------|------------|-----|-------------------------|------|----------------------------------------------|
    | `wb_sku`        | `INTEGER`  | Да  | `wb_products(wb_sku)`   | Нет  | Артикул WB                                   |
    | `wb_fbo_stock`  | `INTEGER`  |     |                         | Да   | Остатки WB                                   |
    | `wb_full_price` | `INTEGER`  |     |                         | Да   | Текущая цена                                 |
    | `wb_discount`   | `INTEGER`  |     |                         | Да   | Текущая скидка                               |

---

## Связи между Таблицами

1.  **Связь: `oz_orders` и `oz_products`**
    *   **Тип:** Один-ко-Многим (Один товар в `oz_products` может быть во многих строках `oz_orders`).
    *   **Условие Объединения (JOIN):**
        *   `oz_orders.oz_sku = oz_products.oz_sku` (предпочтительно, если `oz_sku` в `oz_products` уникален и всегда присутствует)
        *   И/ИЛИ `oz_orders.oz_vendor_code = oz_products.oz_vendor_code` (`oz_vendor_code` менее надежен, так как в отличие от `oz_sku`, `oz_vendor_code` способен меняться)
    *   **Описание:** Позволяет получить полную информацию о товаре для каждой позиции в заказе Ozon.

2.  **Связь: `oz_barcodes` и `oz_products`**
    *   **Тип:** Один-ко-Многим (Один товар в `oz_products` может иметь несколько штрихкодов в `oz_barcodes`).
    *   **Условие Объединения (JOIN):**
        *   `oz_barcodes.oz_product_id = oz_products.oz_product_id`
        *   И/ИЛИ `oz_barcodes.oz_vendor_code = oz_products.oz_vendor_code` (`oz_vendor_code` менее надежен, так как в отличие от `oz_product_id`, `oz_vendor_code` способен меняться. Важно не путать `oz_product_id` и `oz_sku`, это разные значения)
    *   **Описание:** Позволяет получить список штрихкодов для товаров Ozon.

3.  **Связь: `wb_prices` и `wb_products`**
    *   **Тип:** Один-к-Одному (или Один-ко-Многим, если цены могут меняться со временем и хранится история, но текущая схема предполагает одну цену на товар).
    *   **Условие Объединения (JOIN):** `wb_prices.wb_sku = wb_products.wb_sku`
    *   **Описание:** Позволяет получить информацию о ценах для товаров Wildberries.

4.  **Связь: `oz_barcodes` (`oz_barcode`) и `wb_products` (`wb_barcodes`) - Сопоставление товаров по штрихкодам**
    *   **Цель:** Идентификация и связывание идентичных товаров, представленных на Ozon и Wildberries, на основе общих штрихкодов. Это позволяет проводить сквозной анализ или синхронизацию данных по товарам между площадками.
    *   **Проблема:** Прямое связывание таблиц через стандартные механизмы PK-FK затруднено из-за фундаментальных различий в структуре хранения штрихкодов:
        *   В таблице `wb_products` поле `wb_barcodes` может содержать как один штрихкод, так и строку с несколькими штрихкодами, разделенными точкой с запятой (`;`).
        *   В таблице `oz_barcodes` поле `oz_barcode` всегда содержит один штрихкод на запись. Однако, один и тот же товар Ozon (связанный через `oz_product_id` или `oz_vendor_code`) может иметь несколько записей в `oz_barcodes`, каждая с уникальным штрихкодом.
    *   **Предлагаемое решение (Бизнес-логика для сопоставления):**
        1.  **Нормализация штрихкодов Wildberries:** На первом этапе необходимо обработать поле `wb_products.wb_barcodes`. Для каждой записи из `wb_products` нужно извлечь все индивидуальные штрихкоды. Если поле содержит список, его следует разделить на отдельные значения. Это можно представить как создание временного набора данных, где каждая строка содержит пару (`wb_sku`, `wb_individual_barcode`).
        2.  **Прямое сравнение:** После нормализации, каждый `wb_individual_barcode` сравнивается с каждым значением из `oz_barcodes.oz_barcode`.
        3.  **Установление логической связи:** При обнаружении совпадения (`oz_barcodes.oz_barcode = wb_individual_barcode`) устанавливается логическая связь между соответствующим товаром Ozon (например, через `oz_barcodes.oz_product_id`) и товаром Wildberries (`wb_products.wb_sku`).
    *   **Тип связи:** Данная связь является логической, а не физической (основанной на ограничениях внешнего ключа). На уровне уникальных товаров это чаще всего будет связь "один-к-одному" или "многие-к-одному" (если несколько штрихкодов одного товара Ozon соответствуют одному товару WB с одним из этих штрихкодов, или наоборот).
    *   **Реализация:** Эта логика сопоставления обычно реализуется программно на уровне приложения или через сложные SQL-запросы (например, с использованием функций разделения строк для `wb_barcodes` и последующих JOIN-операций по результатам сравнения). Она не обеспечивается стандартными средствами СУБД для поддержания целостности данных.
    *   **Важно:** Качество и уникальность штрихкодов на обеих площадках критически важны для корректности такого сопоставления. Могут потребоваться дополнительные шаги по очистке и стандартизации данных штрихкодов.

---

*(Этот документ был автоматически заполнен на основе `mp_reports_schema.md`. Пожалуйста, просмотрите и дополните его при необходимости, особенно в части определения PK/FK и описания бизнес-логики связей.)*
