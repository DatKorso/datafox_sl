# Changelog

## 2025-01-11 - Универсальная таблица punta_table

### Новая функциональность
Реализована универсальная система для таблицы `punta_table`, которая автоматически адаптируется к любой структуре данных из Google Sheets.

### Ключевые изменения

#### 1. Динамическая схема
- **Автоматическое создание схемы**: Таблица создается на основе заголовков Google Sheets
- **Гибкая структура**: Поддержка любого количества колонок с произвольными названиями
- **Автоматический вывод типов**: DuckDB определяет типы данных автоматически

#### 2. Новые функции
- `import_dynamic_punta_table()`: Динамический импорт с автоматическим созданием схемы
- `get_punta_table_columns()`: Получение списка колонок из существующей таблицы
- `get_dynamic_punta_columns()`: Получение доступных колонок для аналитических отчетов
- `update_punta_columns_dynamically()`: Динамическое обновление PUNTA_ колонок в Excel

#### 3. Обновленная схема
```python
"punta_table": {
    "description": "Данные Punta из Google Sheets (универсальная схема)",
    "file_type": "google_sheets",
    "read_params": {},
    "config_report_key": "punta_google_sheets_url",
    "columns": "DYNAMIC",  # Указывает на динамическую схему
    "pre_update_action": "DROP TABLE IF EXISTS punta_table;"
}
```

#### 4. Улучшенная обработка данных
- **Очистка пустых строк**: Автоматическое удаление строк без данных
- **Валидация wb_sku**: Исключение строк с невалидными wb_sku
- **Конвертация типов**: Автоматическая конвертация wb_sku в INTEGER
- **Полная пересборка**: Таблица пересоздается при каждом импорте

#### 5. Интеграция с аналитическими отчетами
- **Автоматическое обнаружение колонок**: Система находит все доступные колонки
- **Динамические PUNTA_ колонки**: Любая колонка из punta_table доступна как PUNTA_название
- **Универсальное обновление**: Автоматическое заполнение всех PUNTA_ колонок в Excel

### Преимущества

#### Для пользователей
- **Гибкость**: Добавление новых колонок в Google Sheets без изменения кода
- **Простота**: Не нужно знать техническую схему базы данных
- **Автоматизация**: Система сама определяет структуру данных

#### Для разработчиков
- **Универсальность**: Один код работает с любой структурой данных
- **Масштабируемость**: Легкое добавление новых полей
- **Надежность**: Автоматическая валидация и очистка данных

### Техническая реализация
- **DuckDB CREATE TABLE AS SELECT**: Использование автоматического вывода схемы
- **Динамическое SQL**: Построение запросов на основе доступных колонок
- **Информационная схема**: Получение метаданных таблицы через DESCRIBE

### Обратная совместимость
- Существующие данные в punta_table будут заменены при первом импорте
- Аналитические отчеты автоматически адаптируются к новой структуре
- Настройки Google Sheets остаются без изменений

### Файлы изменены
- `utils/db_schema.py`: Обновлена схема punta_table на DYNAMIC
- `utils/db_crud.py`: Добавлены функции динамического импорта
- `utils/analytic_report_helpers.py`: Обновлены функции работы с Punta данными
- `pages/2_Import_Reports.py`: Добавлена информация о универсальной системе
- `project-docs/universal-punta-table.md`: Новая документация

### Миграция
При первом импорте после обновления:
1. Старая таблица punta_table будет удалена
2. Создастся новая таблица с динамической схемой
3. Данные импортируются из Google Sheets

**Рекомендация**: Убедитесь, что Google Sheets содержит все необходимые колонки перед первым импортом.

---

## 2025-01-11 - Исправление типа данных wb_sku в punta_table

### Проблема
При тестировании было обнаружено, что `wb_sku` в таблице `punta_table` имел тип VARCHAR, в то время как во всех других таблицах он имеет числовой тип (INTEGER/BIGINT). Это вызывало проблемы при соединении таблиц в SQL запросах.

### Решение
1. **Обновлена схема**: В `utils/db_schema.py` изменен тип `wb_sku` с VARCHAR на INTEGER для таблицы `punta_table`
2. **Добавлена обработка конверсии**: Добавлен notes `convert_to_integer` для автоматической конвертации строковых wb_sku в числа при импорте
3. **Миграция данных**: Выполнена миграция существующей таблицы с конвертацией данных
4. **Обновлены функции**: Функция `get_punta_data()` обновлена для корректной работы с числовыми wb_sku

### Результат
- Из 9332 записей успешно конвертировано 8553 (779 записей с невалидными wb_sku исключены)
- Все JOIN операции между таблицами теперь работают корректно
- PUNTA_ колонки в аналитических отчетах работают правильно
- Типы данных wb_sku стандартизированы во всех таблицах

### Техническая информация
- **Измененные файлы**: `utils/db_schema.py`, `utils/db_crud.py`, `utils/analytic_report_helpers.py`
- **Обновленная документация**: `project-docs/analytic-report-generation.md`, `project-docs/tech-specs.md`
- **Тестирование**: Проверено на тестовом файле `test_analytic_report_with_punta.xlsx` 