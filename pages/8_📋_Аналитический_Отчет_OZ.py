"""
Streamlit page for generating custom analytic reports.

This page allows users to:
- Select or upload a custom analytic report Excel file
- Process WB SKUs to find related Ozon data
- Generate comprehensive reports with size distribution, stock data, and order statistics
- Update the Excel file with calculated data while preserving structure
"""
import streamlit as st
import os
from utils.db_connection import connect_db
from utils import config_utils
from utils.analytic_report_helpers import process_analytic_report, load_analytic_report_file
import pandas as pd

st.set_page_config(page_title="Analytic Report Generation - Marketplace Analyzer", layout="wide")
st.title("üìà Custom Analytic Report Generation")
st.markdown("---")

# --- Introduction ---
st.markdown("""
### –û —Ñ—É–Ω–∫—Ü–∏–∏
–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö WB SKU.
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ Ozon SKU –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º, –æ—Å—Ç–∞—Ç–∫–∞–º, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∑–∞–∫–∞–∑–æ–≤ –∏ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ Punta.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–∞–π–ª—É
- –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ª–∏—á–∏–µ –ª–∏—Å—Ç–∞ "analytic_report"
- 7-—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
- 8-—è —Å—Ç—Ä–æ–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è)
- –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 9-–π —Å—Ç—Ä–æ–∫–∏
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: **WB_SKU**

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫
- **OZ_SIZE_XX**: –†–∞–∑–º–µ—Ä—ã –æ–±—É–≤–∏ (22-44) —Å Ozon SKU
- **OZ_SIZES**: –î–∏–∞–ø–∞–∑–æ–Ω –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
- **OZ_STOCK**: –°—É–º–º–∞—Ä–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ Ozon
- **ORDERS_TODAY-XX**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º
- **PUNTA_XXX**: –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Punta (NEW!)
  - –ù–∞–ø—Ä–∏–º–µ—Ä: PUNTA_season, PUNTA_gender, PUNTA_material
- **PHOTO_FROM_WB**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —Å WB (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏  
  - –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Wildberries
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ —è—á–µ–π–∫–∏ Excel
""")

# --- Database Connection ---
conn = connect_db()
if not conn:
    st.error("‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.")
    if st.button("Go to Settings"):
        st.switch_page("pages/3_Settings.py")
    st.stop()

# --- File Selection ---
st.subheader("üìÅ –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –æ—Ç—á–µ—Ç–∞")

col1, col2 = st.columns([2, 1])

with col1:
    # Get default path from settings
    default_path = config_utils.get_report_path("analytic_report_xlsx")
    
    # File selection method
    file_source = st.radio(
        "–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª:",
        ["üìÇ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫", "‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª"],
        index=0 if default_path else 1
    )

with col2:
    st.info("üí° **–°–æ–≤–µ—Ç**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ —Ä–∞–∑–¥–µ–ª–µ Settings –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞")

selected_file_path = None

if file_source == "üìÇ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫":
    if default_path:
        if os.path.exists(default_path):
            selected_file_path = default_path
            st.success(f"‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω: `{os.path.basename(default_path)}`")
            st.caption(f"–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: {default_path}")
        else:
            st.error(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {default_path}")
            st.info("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞.")
    else:
        st.warning("‚ö†Ô∏è –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Settings –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞.")

else:  # Upload file
    uploaded_file = st.file_uploader(
        "–í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º –æ—Ç—á–µ—Ç–æ–º:",
        type=['xlsx'],
        help="–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ª–∏—Å—Ç 'analytic_report' —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"
    )
    
    if uploaded_file is not None:
        # Save uploaded file temporarily
        temp_path = f"temp_analytic_report_{uploaded_file.name}"
        with open(temp_path, "wb") as f:
            f.write(uploaded_file.getbuffer())
        selected_file_path = temp_path
        st.success(f"‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: `{uploaded_file.name}`")

# --- File Validation and Preview ---
if selected_file_path:
    st.markdown("---")
    st.subheader("üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞")
    
    # Validate file structure
    df, wb, error_msg = load_analytic_report_file(selected_file_path)
    
    if df is not None:
        st.success("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω")
        
        # Display file statistics
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("üìä –°—Ç—Ä–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏", len(df))
        with col2:
            wb_sku_count = len(df['WB_SKU'].dropna().unique())
            st.metric("üè∑Ô∏è –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö WB SKU", wb_sku_count)
        with col3:
            st.metric("üìã –ö–æ–ª–æ–Ω–æ–∫ –≤ —Ñ–∞–π–ª–µ", len(df.columns))
        with col4:
            if wb_sku_count > 1000:
                st.metric("‚ö†Ô∏è –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞", "–ë–æ–ª—å—à–æ–π", delta="–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è")
            else:
                st.metric("‚úÖ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞", "–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π")
        
        # Preview data
        with st.expander("üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)", expanded=False):
            # Show only relevant columns for preview
            preview_cols = ['WB_SKU'] + [col for col in df.columns if col.startswith('OZ_SIZE_') or col in ['OZ_SIZES', 'OZ_STOCK'] or col.startswith('ORDERS_TODAY-') or col.startswith('PUNTA_')][:15]
            preview_cols = [col for col in preview_cols if col in df.columns]
            st.dataframe(df[preview_cols].head(), use_container_width=True, hide_index=True)
        
        # Show expected columns that will be filled
        with st.expander("üìù –ö–æ–ª–æ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã", expanded=False):
            expected_cols = []
            
            # Size columns
            size_cols = [f"OZ_SIZE_{i}" for i in range(22, 45)]
            found_size_cols = [col for col in size_cols if col in df.columns]
            if found_size_cols:
                expected_cols.append(f"**–†–∞–∑–º–µ—Ä—ã ({len(found_size_cols)} –∫–æ–ª–æ–Ω–æ–∫)**: {', '.join(found_size_cols[:5])}{'...' if len(found_size_cols) > 5 else ''}")
            
            # Summary columns
            summary_cols = ['OZ_SIZES', 'OZ_STOCK']
            found_summary_cols = [col for col in summary_cols if col in df.columns]
            if found_summary_cols:
                expected_cols.append(f"**–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**: {', '.join(found_summary_cols)}")
            
            # Order columns
            order_cols = [col for col in df.columns if col.startswith('ORDERS_TODAY-')]
            if order_cols:
                expected_cols.append(f"**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ ({len(order_cols)} –∫–æ–ª–æ–Ω–æ–∫)**: {', '.join(order_cols[:3])}{'...' if len(order_cols) > 3 else ''}")
            
            # Punta columns
            punta_cols = [col for col in df.columns if col.startswith('PUNTA_')]
            if punta_cols:
                expected_cols.append(f"**–°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Punta ({len(punta_cols)} –∫–æ–ª–æ–Ω–æ–∫)**: {', '.join(punta_cols[:3])}{'...' if len(punta_cols) > 3 else ''}")
            
            # Photo column
            if 'PHOTO_FROM_WB' in df.columns:
                expected_cols.append("**üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤**: PHOTO_FROM_WB - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å WB (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–µ–Ω–æ)")
            
            if expected_cols:
                for col_info in expected_cols:
                    st.markdown(f"- {col_info}")
            else:
                st.warning("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ–∂–∏–¥–∞–µ–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞.")
        
        # --- Processing Section ---
        st.markdown("---")
        st.subheader("üöÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—á–µ—Ç–∞")
        
        if wb_sku_count == 0:
            st.error("‚ùå –í —Ñ–∞–π–ª–µ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö WB SKU –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏")
        else:
            st.info(f"üìã –ë—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ **{wb_sku_count}** —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö WB SKU")
            
            # Warning for large files
            if wb_sku_count > 500:
                st.warning("‚ö†Ô∏è **–ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
            
            # Options section
            st.markdown("#### ‚öôÔ∏è –û–ø—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏")
            
            col1, col2 = st.columns([1, 2])
            
            with col1:
                include_images = st.checkbox(
                    "üñºÔ∏è –ó–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤",
                    value=False,
                    help="–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏ –≤—Å—Ç–∞–≤–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π WB –≤ –∫–æ–ª–æ–Ω–∫—É PHOTO_FROM_WB"
                )
            
            with col2:
                if 'PHOTO_FROM_WB' in df.columns:
                    if include_images:
                        st.success("‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ Excel")
                    else:
                        st.info("üì∑ –ö–æ–ª–æ–Ω–∫–∞ PHOTO_FROM_WB –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è)")
                else:
                    st.info("‚ÑπÔ∏è –ö–æ–ª–æ–Ω–∫–∞ PHOTO_FROM_WB –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ")
            
            if include_images and wb_sku_count > 100:
                st.warning("‚ö†Ô∏è **–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: –ú–æ–∂–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏.")
            
            # Processing button
            process_button = st.button(
                "üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç—á–µ—Ç",
                type="primary",
                help="–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö WB SKU –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞",
                use_container_width=True
            )
            
            if process_button:
                # Start processing
                with st.spinner("üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—á–µ—Ç–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è..."):
                    
                    # Create progress tracking
                    progress_container = st.container()
                    with progress_container:
                        progress_bar = st.progress(0)
                        status_text = st.empty()
                        
                        status_text.text("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...")
                        progress_bar.progress(10)
                        
                        # Process the report
                        success, error_msg, stats = process_analytic_report(conn, selected_file_path, include_images)
                        
                        if success:
                            progress_bar.progress(100)
                            status_text.text("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
                            
                            st.success("üéâ **–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ –æ–±–Ω–æ–≤–ª–µ–Ω!**")
                            
                            # Display statistics
                            st.markdown("### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏")
                            col1, col2, col3, col4, col5 = st.columns(5)
                            
                            with col1:
                                st.metric(
                                    "üìã –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ WB SKU",
                                    stats.get('processed_wb_skus', 0)
                                )
                            with col2:
                                st.metric(
                                    "üîó –ù–∞–π–¥–µ–Ω—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è Ozon",
                                    stats.get('wb_skus_with_ozon_matches', 0),
                                    delta=f"{stats.get('wb_skus_with_ozon_matches', 0) / max(stats.get('processed_wb_skus', 1), 1) * 100:.1f}%"
                                )
                            with col3:
                                st.metric(
                                    "üè∑Ô∏è –ù–∞–π–¥–µ–Ω–æ Ozon SKU",
                                    stats.get('total_ozon_skus_found', 0)
                                )
                            with col4:
                                st.metric(
                                    "üì¶ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫",
                                    f"{stats.get('total_stock', 0):,}".replace(',', ' ')
                                )
                            with col5:
                                st.metric(
                                    "üìö –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ Punta",
                                    stats.get('wb_skus_with_punta_data', 0),
                                    delta=f"{stats.get('wb_skus_with_punta_data', 0) / max(stats.get('processed_wb_skus', 1), 1) * 100:.1f}%"
                                )
                            
                            # Success actions
                            st.markdown("### üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?")
                            
                            # Different handling for uploaded vs configured files
                            if selected_file_path.startswith('temp_'):
                                # For uploaded files - offer download
                                st.info("üìÅ **–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª**: –§–∞–π–ª –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –°–∫–∞—á–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –Ω–∏–∂–µ.")
                                
                                col1, col2 = st.columns(2)
                                with col1:
                                    # Provide download button
                                    with open(selected_file_path, "rb") as file:
                                        btn = st.download_button(
                                            label="üíæ –°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª",
                                            data=file.read(),
                                            file_name=f"processed_{uploaded_file.name}",
                                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                                            use_container_width=True
                                        )
                                
                                with col2:
                                    if st.button("üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª", use_container_width=True):
                                        # Clean up temp file
                                        try:
                                            os.remove(selected_file_path)
                                        except:
                                            pass
                                        st.rerun()
                                
                                st.warning("‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ.")
                                
                            else:
                                # For configured files - normal backup created
                                col1, col2 = st.columns(2)
                                
                                with col1:
                                    st.info("üìÅ **–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è**: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å timestamp")
                                    st.info("üíæ **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª**: –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª")
                                
                                with col2:
                                    if st.button("üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª", use_container_width=True):
                                        st.rerun()
                            
                            st.balloons()
                            
                        else:
                            progress_bar.progress(0)
                            status_text.text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ")
                            st.error(f"‚ùå **–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç—á–µ—Ç–∞:**\n\n{error_msg}")
                            
                            # Error help
                            with st.expander("üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –æ—à–∏–±–æ–∫"):
                                st.markdown("""
                                **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫:**
                                1. **–§–∞–π–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω**: –ó–∞–∫—Ä–æ–π—Ç–µ Excel —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                                2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–æ–º
                                3. **–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ WB SKU –µ—Å—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                                4. **–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
                                5. **–ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                                """)
    else:
        st.error(f"‚ùå **–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞:**\n\n{error_msg}")
        
        # Help section for file structure
        with st.expander("üìñ –ü–æ–º–æ—â—å: –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ñ–∞–π–ª–∞"):
            st.markdown("""
            ### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞:
            
            1. **–õ–∏—Å—Ç**: –î–æ–ª–∂–µ–Ω –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `analytic_report`
            2. **–°—Ç—Ä–æ–∫–∞ 7**: –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `N`, `WB_SKU`, `OZ_SIZE_27`, `OZ_SIZE_28`, ..., `OZ_SIZES`, `OZ_STOCK`, `ORDERS_TODAY-30`, ...)
            3. **–°—Ç—Ä–æ–∫–∞ 8**: –û–ø–∏—Å–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ)
            4. **–°—Ç—Ä–æ–∫–∏ 9+**: –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            
            ### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏:
            - **WB_SKU**: –ê—Ä—Ç–∏–∫—É–ª WB (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            
            ### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã):
            - **OZ_SIZE_22** –¥–æ **OZ_SIZE_44**: Ozon SKU –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º
            - **OZ_SIZES**: –î–∏–∞–ø–∞–∑–æ–Ω —Ä–∞–∑–º–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "27-38")
            - **OZ_STOCK**: –°—É–º–º–∞—Ä–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ Ozon
            - **ORDERS_TODAY-30** –¥–æ **ORDERS_TODAY-1**: –ó–∞–∫–∞–∑—ã –ø–æ –¥–Ω—è–º
            - **PUNTA_XXX**: –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Punta
            - **PHOTO_FROM_WB**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —Å WB (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
            ### –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 7):
            ```
            N | WB_SKU | PHOTO_FROM_WB | OZ_SIZE_27 | OZ_SIZE_28 | ... | OZ_SIZES | OZ_STOCK | ORDERS_TODAY-30 | PUNTA_season | ...
            ```
            """)

else:
    # No file selected
    st.info("üëÜ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã")

# --- Help Section ---
st.markdown("---")
with st.expander("‚ùì –°–ø—Ä–∞–≤–∫–∞ –∏ –ø—Ä–∏–º–µ—Ä—ã"):
    st.markdown("""
    ### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞:
    
    1. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞**: –°–∏—Å—Ç–µ–º–∞ —á–∏—Ç–∞–µ—Ç Excel —Ñ–∞–π–ª –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    2. **–ü–æ–∏—Å–∫ —Å–≤—è–∑–µ–π**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ WB SKU –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ Ozon SKU —á–µ—Ä–µ–∑ –æ–±—â–∏–µ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã
    3. **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º**: Ozon SKU –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º –æ–±—É–≤–∏
    4. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ—Å—Ç–∞—Ç–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    5. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ PHOTO_FROM_WB –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —Å WB
    6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞**: –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    
    ### –ß—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è:
    - **OZ_SIZE_XX**: Ozon SKU –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—É–≤–∏
    - **OZ_SIZES**: –î–∏–∞–ø–∞–∑–æ–Ω –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    - **OZ_STOCK**: –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ FBO —Å—Ö–µ–º–µ
    - **ORDERS_TODAY-XX**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    - **PUNTA_XXX**: –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Punta –ø–æ –æ–±—â–µ–º—É WB SKU
    - **PHOTO_FROM_WB**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —è—á–µ–π–∫–∞–º (–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)
    
    ### –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Punta:
    - **PUNTA_gender**: –ü–æ–ª (–ú–∞–ª—å—á–∏–∫–∏/–î–µ–≤–æ—á–∫–∏)
    - **PUNTA_season**: –°–µ–∑–æ–Ω (–õ–µ—Ç–æ/–î–µ–º–∏/–ó–∏–º–∞)
    - **PUNTA_model_name**: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
    - **PUNTA_material**: –û–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    - **PUNTA_new_last, PUNTA_mega_last, PUNTA_best_last**: –ö–æ–¥—ã last
    
    ### –§—É–Ω–∫—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π PHOTO_FROM_WB (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è):
    - **–í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –≤—ã–±–æ—Ä—É**: –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    - **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ WB_SKU
    - **–ê–ª–≥–æ—Ä–∏—Ç–º WB**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º, —á—Ç–æ –∏ –≤ Wildberries –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    - **–í—Å—Ç–∞–≤–∫–∞ –≤ Excel**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ —è—á–µ–π–∫–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫
    - **–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —è—á–µ–π–∫–∞–º**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —è—á–µ–π–∫–∞–º –∏ –¥–≤–∏–≥–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    - **–ß–∏—Å—Ç—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –Ø—á–µ–π–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    - **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞**: WebP –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ PNG –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Excel
    - **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏**: –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    - **–ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ–ª–æ–Ω–∫–∞ –æ—á–∏—â–∞–µ—Ç—Å—è –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    
    ### –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:
    - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ Settings –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª Excel –Ω–µ –æ—Ç–∫—Ä—ã—Ç –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö
    - –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>500 WB SKU) –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
    - –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    - –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    - –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
    - –î–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
    
    ### –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (—Å—Ç—Ä–æ–∫–∞ 7):
    ```
    N | WB_SKU | PHOTO_FROM_WB | OZ_SIZE_27 | OZ_SIZE_28 | ... | OZ_SIZES | OZ_STOCK | ORDERS_TODAY-30 | PUNTA_season | ...
    ```
    
    ### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
    - **–§–æ—Ä–º–∞—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ WebP (—Å—Ç–∞–Ω–¥–∞—Ä—Ç WB)
    - **–§–æ—Ä–º–∞—Ç –≤ Excel**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ PNG –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Excel
    - **–†–∞–∑–º–µ—Ä**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 64x64 –ø–∏–∫—Å–µ–ª–µ–π –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    - **–ü—Ä–∏–≤—è–∑–∫–∞**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —è—á–µ–π–∫–∞–º —á–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–æ anchor
    - **–ü–æ–≤–µ–¥–µ–Ω–∏–µ**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è –∏ –∏–∑–º–µ–Ω—è—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —è—á–µ–π–∫–∞–º–∏
    - **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
    - **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
    - **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö PNG —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    """)

# Cleanup temporary files on script end
if selected_file_path and selected_file_path.startswith('temp_') and os.path.exists(selected_file_path):
    try:
        # Register cleanup function (this won't work in Streamlit, but it's good practice)
        import atexit
        atexit.register(lambda: os.remove(selected_file_path) if os.path.exists(selected_file_path) else None)
    except:
        pass

if conn:
    conn.close() 