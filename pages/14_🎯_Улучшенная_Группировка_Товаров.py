"""–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.

–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–µ–π —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–æ–≤
- –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–æ–≤ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ UI
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
- üÜï –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö

–ê–≤—Ç–æ—Ä: DataFox SL Project
–í–µ—Ä—Å–∏—è: 2.1.2
"""

import streamlit as st
import pandas as pd
from typing import List, Optional
import traceback

# –ò–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
from utils.db_connection import connect_db
from utils.advanced_product_grouper import AdvancedProductGrouper, GroupingConfig
from utils.advanced_grouping_ui_components import (
    render_grouping_configuration,
    render_wb_sku_input,
    render_grouping_results,
    render_export_options,
    render_help_section
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–£–ª—É—á—à–µ–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤",
    page_icon="üéØ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.title("üéØ –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤")
st.markdown("""
–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ 
—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–µ–π —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

**–ù–æ–≤–æ–µ**: –¢–µ–ø–µ—Ä—å –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤! üì∏
""")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
try:
    conn = connect_db()
    if conn is None:
        st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.")
        st.stop()
except Exception as e:
    st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
    st.stop()

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
with st.sidebar:
    st.markdown("### üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
    st.markdown("""
    **–í–µ—Ä—Å–∏—è:** 2.1.2
    
    **–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
    - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã SQL –∑–∞–ø—Ä–æ—Å—ã
    - ‚úÖ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–æ–≤
    - ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    - ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
    - ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
    - üÜï **–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö**
    - üîß **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤**
    """)
    
    st.markdown("### üîß –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã")
    st.success("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
    
    # –°–ø—Ä–∞–≤–∫–∞
    render_help_section()

# –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
tab1, tab2 = st.tabs(["üéØ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞", "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã"])

with tab1:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
    config = render_grouping_configuration()
    
    st.divider()
    
    # –í–≤–æ–¥ WB SKU
    wb_skus = render_wb_sku_input()
    
    st.divider()
    
    # –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        if st.button(
            "üöÄ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—ã",
            type="primary",
            use_container_width=True,
            disabled=len(wb_skus) == 0
        ):
            if len(wb_skus) == 0:
                st.error("‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ WB SKU –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏")
            else:
                # –ó–∞–ø—É—Å–∫–∞–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É
                with st.spinner("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤..."):
                    try:
                        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –≥—Ä—É–ø–ø–∏—Ä–æ–≤—â–∏–∫–∞
                        grouper = AdvancedProductGrouper(conn)
                        
                        # –í—ã–ø–æ–ª–Ω—è–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É
                        result = grouper.create_advanced_product_groups(wb_skus, config)
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ session_state
                        st.session_state['grouping_result'] = result
                        st.session_state['grouping_config'] = config
                        
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        st.success(f"‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ–∑–¥–∞–Ω–æ {result.statistics.get('total_groups', 0)} –≥—Ä—É–ø–ø")
                        
                        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        st.info("üìä –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
                        
                    except Exception as e:
                        st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: {str(e)}")
                        
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ –≤ expander
                        with st.expander("üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏", expanded=False):
                            st.code(traceback.format_exc())

with tab2:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
    if 'grouping_result' not in st.session_state:
        st.info("üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –Ω–∞ –≤–∫–ª–∞–¥–∫–µ '–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞'.")
    else:
        result = st.session_state['grouping_result']
        config = st.session_state.get('grouping_config')
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        if config:
            with st.expander("‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏", expanded=False):
                col1, col2 = st.columns(2)
                
                with col1:
                    st.write(f"**–ö–æ–ª–æ–Ω–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:** {', '.join(config.grouping_columns)}")
                    st.write(f"**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥:** {config.min_group_rating}")
                
                with col2:
                    st.write(f"**–ú–∞–∫—Å–∏–º—É–º SKU –≤ –≥—Ä—É–ø–ø–µ:** {config.max_wb_sku_per_group}")
                    st.write(f"**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ sort:** {'–î–∞' if config.enable_sort_priority else '–ù–µ—Ç'}")
                
                if config.wb_category:
                    st.write(f"**–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:** {config.wb_category}")
        
        st.divider()
        
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        render_grouping_results(result)
        
        st.divider()
        
        # –û–ø—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        render_export_options(result)
        
        # –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        st.divider()
        
        col1, col2, col3 = st.columns([1, 2, 1])
        
        with col2:
            if st.button(
                "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
                use_container_width=True,
                help="–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏"
            ):
                if 'grouping_result' in st.session_state:
                    del st.session_state['grouping_result']
                if 'grouping_config' in st.session_state:
                    del st.session_state['grouping_config']
                
                st.success("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã")
                st.rerun()

# –§—É—Ç–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.divider()
st.markdown("""
<div style='text-align: center; color: #666; font-size: 0.8em;'>
    DataFox SL - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ v2.0.0<br>
    –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–µ–π —Ä–µ–π—Ç–∏–Ω–≥–∞
</div>
""", unsafe_allow_html=True)

# –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
if 'conn' in locals() and conn:
    conn.close()